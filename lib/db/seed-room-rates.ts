import { config } from "dotenv";
import { drizzle } from "drizzle-orm/postgres-js";
import postgres from "postgres";
import { eq } from "drizzle-orm";
import {
  rooms,
  services,
  roomRates,
} from "./schema";

config({ path: ".env.local" });

const client = postgres(process.env.POSTGRES_URL!);
const db = drizzle(client);

// The room rate data provided - starting from 1/1/2024
const roomRateData = `hotel_name        1/1/2024    1/2/2024    1/3/2024    1/4/2024    1/5/2024    1/6/2024    1/7/2024    1/8/2024    1/9/2024    1/10/2024    1/11/2024    1/12/2024    1/13/2024    1/14/2024    1/15/2024    1/16/2024    1/17/2024    1/18/2024    1/19/2024    1/20/2024    1/21/2024    1/22/2024    1/23/2024    1/24/2024    1/25/2024    1/26/2024    1/27/2024    1/28/2024    1/29/2024    1/30/2024    1/31/2024    2/1/2024    2/2/2024    2/3/2024    2/4/2024    2/5/2024    2/6/2024    2/7/2024    2/8/2024    2/9/2024    2/10/2024    2/11/2024    2/12/2024    2/13/2024    2/14/2024    2/15/2024    2/16/2024    2/17/2024    2/18/2024    2/19/2024    2/20/2024    2/21/2024    2/22/2024    2/23/2024    2/24/2024    2/25/2024    2/26/2024    2/27/2024    2/28/2024    2/29/2024    3/1/2024    3/2/2024    3/3/2024    3/4/2024    3/5/2024    3/6/2024    3/7/2024    3/8/2024    3/9/2024    3/10/2024    3/11/2024    3/12/2024    3/13/2024    3/14/2024    3/15/2024    3/16/2024    3/17/2024    3/18/2024    3/19/2024    3/20/2024    3/21/2024    3/22/2024    3/23/2024    3/24/2024    3/25/2024    3/26/2024    3/27/2024    3/28/2024    3/29/2024    3/30/2024    3/31/2024    4/1/2024    4/2/2024    4/3/2024    4/4/2024    4/5/2024    4/6/2024    4/7/2024    4/8/2024    4/9/2024    4/10/2024    4/11/2024    4/12/2024    4/13/2024    4/14/2024    4/15/2024    4/16/2024    4/17/2024    4/18/2024    4/19/2024    4/20/2024    4/21/2024    4/22/2024    4/23/2024    4/24/2024    4/25/2024    4/26/2024    4/27/2024    4/28/2024    4/29/2024    4/30/2024    5/1/2024    5/2/2024    5/3/2024    5/4/2024    5/5/2024    5/6/2024    5/7/2024    5/8/2024    5/9/2024    5/10/2024    5/11/2024    5/12/2024    5/13/2024    5/14/2024    5/15/2024    5/16/2024    5/17/2024    5/18/2024    5/19/2024    5/20/2024    5/21/2024    5/22/2024    5/23/2024    5/24/2024    5/25/2024    5/26/2024    5/27/2024    5/28/2024    5/29/2024    5/30/2024    5/31/2024    6/1/2024    6/2/2024    6/3/2024    6/4/2024    6/5/2024    6/6/2024    6/7/2024    6/8/2024    6/9/2024    6/10/2024    6/11/2024    6/12/2024    6/13/2024    6/14/2024    6/15/2024    6/16/2024    6/17/2024    6/18/2024    6/19/2024    6/20/2024    6/21/2024    6/22/2024    6/23/2024    6/24/2024    6/25/2024    6/26/2024    6/27/2024    6/28/2024    6/29/2024    6/30/2024    7/1/2024    7/2/2024    7/3/2024    7/4/2024    7/5/2024    7/6/2024    7/7/2024    7/8/2024    7/9/2024    7/10/2024    7/11/2024    7/12/2024    7/13/2024    7/14/2024    7/15/2024    7/16/2024    7/17/2024    7/18/2024    7/19/2024    7/20/2024    7/21/2024    7/22/2024    7/23/2024    7/24/2024    7/25/2024    7/26/2024    7/27/2024    7/28/2024    7/29/2024    7/30/2024    7/31/2024    8/1/2024    8/2/2024    8/3/2024    8/4/2024    8/5/2024    8/6/2024    8/7/2024    8/8/2024    8/9/2024    8/10/2024    8/11/2024    8/12/2024    8/13/2024    8/14/2024    8/15/2024    8/16/2024    8/17/2024    8/18/2024    8/19/2024    8/20/2024    8/21/2024    8/22/2024    8/23/2024    8/24/2024    8/25/2024    8/26/2024    8/27/2024    8/28/2024    8/29/2024    8/30/2024    8/31/2024    9/1/2024    9/2/2024    9/3/2024    9/4/2024    9/5/2024    9/6/2024    9/7/2024    9/8/2024    9/9/2024    9/10/2024    9/11/2024    9/12/2024    9/13/2024    9/14/2024    9/15/2024    9/16/2024    9/17/2024    9/18/2024    9/19/2024    9/20/2024    9/21/2024    9/22/2024    9/23/2024    9/24/2024    9/25/2024    9/26/2024    9/27/2024    9/28/2024    9/29/2024    9/30/2024    10/1/2024    10/2/2024    10/3/2024    10/4/2024    10/5/2024    10/6/2024    10/7/2024    10/8/2024    10/9/2024    10/10/2024    10/11/2024    10/12/2024    10/13/2024    10/14/2024    10/15/2024    10/16/2024    10/17/2024    10/18/2024    10/19/2024    10/20/2024    10/21/2024    10/22/2024    10/23/2024    10/24/2024    10/25/2024    10/26/2024    10/27/2024    10/28/2024    10/29/2024    10/30/2024    10/31/2024    11/1/2024    11/2/2024    11/3/2024    11/4/2024    11/5/2024    11/6/2024    11/7/2024    11/8/2024    11/9/2024    11/10/2024    11/11/2024    11/12/2024    11/13/2024    11/14/2024    11/15/2024    11/16/2024    11/17/2024    11/18/2024    11/19/2024    11/20/2024    11/21/2024    11/22/2024    11/23/2024    11/24/2024    11/25/2024    11/26/2024    11/27/2024    11/28/2024    11/29/2024    11/30/2024    12/1/2024    12/2/2024    12/3/2024    12/4/2024    12/5/2024    12/6/2024    12/7/2024    12/8/2024    12/9/2024    12/10/2024    12/11/2024    12/12/2024    12/13/2024    12/14/2024    12/15/2024    12/16/2024    12/17/2024    12/18/2024    12/19/2024    12/20/2024    12/21/2024    12/22/2024    12/23/2024    12/24/2024    12/25/2024    12/26/2024    12/27/2024    12/28/2024    12/29/2024    12/30/2024    12/31/2024    1/1/2025    1/2/2025    1/3/2025    1/4/2025    1/5/2025    1/6/2025    1/7/2025    1/8/2025    1/9/2025    1/10/2025    1/11/2025    1/12/2025    1/13/2025    1/14/2025    1/15/2025    1/16/2025    1/17/2025    1/18/2025    1/19/2025    1/20/2025    1/21/2025    1/22/2025    1/23/2025    1/24/2025    1/25/2025    1/26/2025    1/27/2025    1/28/2025    1/29/2025    1/30/2025    1/31/2025    2/1/2025    2/2/2025    2/3/2025    2/4/2025    2/5/2025    2/6/2025    2/7/2025    2/8/2025    2/9/2025    2/10/2025    2/11/2025    2/12/2025    2/13/2025    2/14/2025    2/15/2025    2/16/2025    2/17/2025    2/18/2025    2/19/2025    2/20/2025    2/21/2025    2/22/2025    2/23/2025    2/24/2025    2/25/2025    2/26/2025    2/27/2025    2/28/2025    3/1/2025    3/2/2025    3/3/2025    3/4/2025    3/5/2025    3/6/2025    3/7/2025    3/8/2025    3/9/2025    3/10/2025    3/11/2025    3/12/2025    3/13/2025    3/14/2025    3/15/2025    3/16/2025    3/17/2025    3/18/2025    3/19/2025    3/20/2025    3/21/2025    3/22/2025    3/23/2025    3/24/2025    3/25/2025    3/26/2025    3/27/2025    3/28/2025    3/29/2025    3/30/2025    3/31/2025    4/1/2025    4/2/2025    4/3/2025    4/4/2025    4/5/2025    4/6/2025    4/7/2025    4/8/2025    4/9/2025    4/10/2025    4/11/2025    4/12/2025    4/13/2025    4/14/2025    4/15/2025    4/16/2025    4/17/2025    4/18/2025    4/19/2025    4/20/2025    4/21/2025    4/22/2025    4/23/2025    4/24/2025    4/25/2025    4/26/2025    4/27/2025    4/28/2025    4/29/2025    4/30/2025    5/1/2025    5/2/2025    5/3/2025    5/4/2025    5/5/2025    5/6/2025    5/7/2025    5/8/2025    5/9/2025    5/10/2025    5/11/2025    5/12/2025    5/13/2025    5/14/2025    5/15/2025    5/16/2025    5/17/2025    5/18/2025    5/19/2025    5/20/2025    5/21/2025    5/22/2025    5/23/2025    5/24/2025    5/25/2025    5/26/2025    5/27/2025    5/28/2025    5/29/2025    5/30/2025    5/31/2025    6/1/2025    6/2/2025    6/3/2025    6/4/2025    6/5/2025    6/6/2025    6/7/2025    6/8/2025    6/9/2025    6/10/2025    6/11/2025    6/12/2025    6/13/2025    6/14/2025    6/15/2025    6/16/2025    6/17/2025    6/18/2025    6/19/2025    6/20/2025    6/21/2025    6/22/2025    6/23/2025    6/24/2025    6/25/2025    6/26/2025    6/27/2025    6/28/2025    6/29/2025    6/30/2025    7/1/2025    7/2/2025    7/3/2025    7/4/2025    7/5/2025    7/6/2025    7/7/2025    7/8/2025    7/9/2025    7/10/2025    7/11/2025    7/12/2025    7/13/2025    7/14/2025    7/15/2025    7/16/2025    7/17/2025    7/18/2025    7/19/2025    7/20/2025    7/21/2025    7/22/2025    7/23/2025    7/24/2025    7/25/2025    7/26/2025    7/27/2025    7/28/2025    7/29/2025    7/30/2025    7/31/2025    8/1/2025    8/2/2025    8/3/2025    8/4/2025    8/5/2025    8/6/2025    8/7/2025    8/8/2025    8/9/2025    8/10/2025    8/11/2025    8/12/2025    8/13/2025    8/14/2025    8/15/2025    8/16/2025    8/17/2025    8/18/2025    8/19/2025    8/20/2025    8/21/2025    8/22/2025    8/23/2025    8/24/2025    8/25/2025    8/26/2025    8/27/2025    8/28/2025    8/29/2025    8/30/2025    8/31/2025    9/1/2025    9/2/2025    9/3/2025    9/4/2025    9/5/2025    9/6/2025    9/7/2025    9/8/2025    9/9/2025    9/10/2025    9/11/2025    9/12/2025    9/13/2025    9/14/2025    9/15/2025    9/16/2025    9/17/2025    9/18/2025    9/19/2025    9/20/2025    9/21/2025    9/22/2025    9/23/2025    9/24/2025    9/25/2025    9/26/2025    9/27/2025    9/28/2025    9/29/2025    9/30/2025    10/1/2025    10/2/2025    10/3/2025    10/4/2025    10/5/2025    10/6/2025    10/7/2025    10/8/2025    10/9/2025    10/10/2025    10/11/2025    10/12/2025    10/13/2025    10/14/2025    10/15/2025    10/16/2025    10/17/2025    10/18/2025    10/19/2025    10/20/2025    10/21/2025    10/22/2025    10/23/2025    10/24/2025    10/25/2025    10/26/2025    10/27/2025    10/28/2025    10/29/2025    10/30/2025    10/31/2025    11/1/2025    11/2/2025    11/3/2025    11/4/2025    11/5/2025    11/6/2025    11/7/2025    11/8/2025    11/9/2025    11/10/2025    11/11/2025    11/12/2025    11/13/2025    11/14/2025    11/15/2025    11/16/2025    11/17/2025    11/18/2025    11/19/2025    11/20/2025    11/21/2025    11/22/2025    11/23/2025    11/24/2025    11/25/2025    11/26/2025    11/27/2025    11/28/2025    11/29/2025    11/30/2025    12/1/2025    12/2/2025    12/3/2025    12/4/2025    12/5/2025    12/6/2025    12/7/2025    12/8/2025    12/9/2025    12/10/2025    12/11/2025    12/12/2025    12/13/2025    12/14/2025    12/15/2025    12/16/2025    12/17/2025    12/18/2025    12/19/2025    12/20/2025    12/21/2025    12/22/2025    12/23/2025    12/24/2025    12/25/2025    12/26/2025    12/27/2025    12/28/2025    12/29/2025    12/30/2025    12/31/2025    1/1/2026    1/2/2026    1/3/2026    1/4/2026    1/5/2026    1/6/2026    1/7/2026    1/8/2026    1/9/2026    1/10/2026    1/11/2026    1/12/2026    1/13/2026    1/14/2026    1/15/2026    1/16/2026    1/17/2026    1/18/2026    1/19/2026    1/20/2026    1/21/2026    1/22/2026    1/23/2026    1/24/2026    1/25/2026    1/26/2026    1/27/2026    1/28/2026    1/29/2026    1/30/2026    1/31/2026    2/1/2026    2/2/2026    2/3/2026    2/4/2026    2/5/2026    2/6/2026    2/7/2026    2/8/2026    2/9/2026    2/10/2026    2/11/2026    2/12/2026    2/13/2026    2/14/2026    2/15/2026    2/16/2026    2/17/2026    2/18/2026    2/19/2026    2/20/2026    2/21/2026    2/22/2026    2/23/2026    2/24/2026    2/25/2026    2/26/2026    2/27/2026    2/28/2026    3/1/2026    3/2/2026    3/3/2026    3/4/2026    3/5/2026    3/6/2026    3/7/2026    3/8/2026    3/9/2026    3/10/2026    3/11/2026    3/12/2026
The Ned NoMad    base    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450    585    608    338    450    450    450`;

function parseRoomRateData(data: string) {
  const lines = data.trim().split('\n');
  const headerLine = lines[0];
  const dataLine = lines[1];
  
  // Parse header to get dates
  const headerParts = headerLine.split(/\s+/);
  const dates = headerParts.slice(2); // Skip 'hotel_name' and room type
  
  // Parse data line
  const dataParts = dataLine.split(/\s+/);
  const hotelName = dataParts.slice(0, 2).join(' '); // "The Ned"
  const roomType = dataParts[2]; // "base" 
  const prices = dataParts.slice(3); // All the prices
  
  console.log(`Hotel: ${hotelName}, Room Type: ${roomType}`);
  console.log(`Found ${dates.length} dates and ${prices.length} prices`);
  
  // Create date-price pairs
  const ratePairs = [];
  for (let i = 0; i < Math.min(dates.length, prices.length); i++) {
    const dateStr = dates[i];
    const price = prices[i];
    
    // Convert M/D/YYYY to YYYY-MM-DD format
    const [month, day, year] = dateStr.split('/');
    const formattedDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
    
    ratePairs.push({
      date: formattedDate,
      price: parseFloat(price)
    });
  }
  
  return ratePairs;
}

async function seedRoomRates() {
  console.log("Seeding room rates...");
  
  try {
    // Parse the rate data
    const ratePairs = parseRoomRateData(roomRateData);
    console.log(`Parsed ${ratePairs.length} rate entries`);
    
    // Get all rooms and the base rate service
    const allRooms = await db.select().from(rooms);
    const baseService = await db.select().from(services).where(eq(services.name, "Base Rate"));
    
    if (baseService.length === 0) {
      throw new Error("Base Rate service not found");
    }
    
    console.log(`Found ${allRooms.length} rooms to populate with rates`);
    
    // Clear existing room rates first
    await db.delete(roomRates);
    console.log("✓ Existing room rates cleared");
    
    // Create room rates for each room and each date
    const roomRateEntries = [];
    
    for (const room of allRooms) {
      for (const ratePair of ratePairs) {
        roomRateEntries.push({
          day: ratePair.date,
          roomId: room.id,
          serviceId: room.serviceId,
          status: "empty" as const, // Default to empty
          priceUsd: ratePair.price.toFixed(2),
        });
      }
    }
    
    console.log(`Creating ${roomRateEntries.length} room rate entries...`);
    
    // Insert in batches to avoid memory issues
    const batchSize = 1000;
    let totalInserted = 0;
    
    for (let i = 0; i < roomRateEntries.length; i += batchSize) {
      const batch = roomRateEntries.slice(i, i + batchSize);
      await db.insert(roomRates).values(batch);
      totalInserted += batch.length;
      console.log(`✓ Inserted batch: ${totalInserted}/${roomRateEntries.length} entries`);
    }
    
    console.log("\n🎉 Room rates seeding completed successfully!");
    console.log(`
Summary:
- Total rooms: ${allRooms.length}
- Date range: ${ratePairs[0].date} to ${ratePairs[ratePairs.length - 1].date}
- Total entries: ${totalInserted}
- Price range: $${Math.min(...ratePairs.map(r => r.price))} - $${Math.max(...ratePairs.map(r => r.price))}
    `);
    
  } catch (error) {
    console.error("Error seeding room rates:", error);
    throw error;
  } finally {
    await client.end();
  }
}

if (require.main === module) {
  seedRoomRates().catch((error) => {
    console.error("Room rates seeding failed:", error);
    process.exit(1);
  });
}

export { seedRoomRates };